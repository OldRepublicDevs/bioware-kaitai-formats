
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <title>Ncs format specification</title>
  </head>
  <body>
           <div class="container">
  <h1>Ncs format specification</h1>

      
<a name='type-ncs'></a>
<h1>Type: Ncs</h1>

<p>NCS (NWScript Compiled) files contain compiled NWScript bytecode used in KotOR and TSL.
Scripts run inside a stack-based virtual machine shared across Aurora engine games.

Format Structure:
- Header (13 bytes): Signature "NCS ", version "V1.0", size marker (0x42), file size
- Instruction Stream: Sequence of bytecode instructions

All multi-byte values in NCS files are stored in BIG-ENDIAN byte order (network byte order).

References:
- https://github.com/OldRepublicDevs/PyKotor/wiki/NCS-File-Format.md - Complete NCS format documentation
- NSS.ksy - NWScript source code that compiles to NCS
</p>
<table class="table">
<tr><th>Offset</th><th>Size</th><th>ID</th><th>Type</th><th>Note</th></tr>
<tr>
<td>0</td>
<td>...</td>
<td>file_type</td>
<td>str(ASCII)</td>
<td>File type signature. Must be "NCS " (0x4E 0x43 0x53 0x20).</td>
</tr>
<tr>
<td>4</td>
<td>...</td>
<td>file_version</td>
<td>str(ASCII)</td>
<td>File format version. Must be "V1.0" (0x56 0x31 0x2E 0x30).</td>
</tr>
<tr>
<td>8</td>
<td>...</td>
<td>size_marker</td>
<td>u1</td>
<td>Program size marker opcode. Must be 0x42.
This is not a real instruction but a metadata field containing the total file size.
All implementations validate this marker before parsing instructions.
</td>
</tr>
<tr>
<td>9</td>
<td>...</td>
<td>file_size</td>
<td>u4be</td>
<td>Total file size in bytes (big-endian).
This value should match the actual file size.
</td>
</tr>
<tr>
<td>13</td>
<td>...</td>
<td>instructions</td>
<td><a href="#type-ncs-instruction">Instruction</a></td>
<td>Stream of bytecode instructions.
Execution begins at offset 13 (0x0D) after the header.
Instructions continue until end of file.
</td>
</tr>
</table>
<a name='type-ncs-instruction'></a>
<h2>Type: Instruction</h2>

<p>NWScript bytecode instruction.
Format: <opcode: uint8> <qualifier: uint8> <arguments: variable>

Instruction size varies by opcode:
- Base: 2 bytes (opcode + qualifier)
- Arguments: 0 to variable bytes depending on instruction type

Common instruction types:
- Constants: CONSTI (6B), CONSTF (6B), CONSTS (2+N B), CONSTO (6B)
- Stack ops: CPDOWNSP, CPTOPSP, MOVSP (variable size)
- Arithmetic: ADDxx, SUBxx, MULxx, DIVxx (2B)
- Control flow: JMP, JSR, JZ, JNZ (6B), RETN (2B)
- Function calls: ACTION (5B)
- And many more (see NCS format documentation)
</p>
<table class="table">
<tr><th>Offset</th><th>Size</th><th>ID</th><th>Type</th><th>Note</th></tr>
<tr>
<td>0</td>
<td>...</td>
<td>opcode</td>
<td>u1</td>
<td>Instruction opcode (0x01-0x2D, excluding 0x42 which is reserved for size marker).
Determines the instruction type and argument format.
</td>
</tr>
<tr>
<td>1</td>
<td>...</td>
<td>qualifier</td>
<td>u1</td>
<td>Qualifier byte that refines the instruction to specific operand types.
Examples: 0x03=Int, 0x04=Float, 0x05=String, 0x06=Object, 0x24=Structure
</td>
</tr>
<tr>
<td>2</td>
<td>...</td>
<td>arguments</td>
<td>u1</td>
<td>Instruction arguments (variable size).
Format depends on opcode:
- No args: None (total 2B)
- Int/Float/Object: 4 bytes (total 6B)
- String: 2B length + data (total 2+N B)
- Jump: 4B signed offset (total 6B)
- Stack copy: 4B offset + 2B size (total 8B)
- ACTION: 2B routine + 1B argCount (total 5B)
- DESTRUCT: 2B size + 2B offset + 2B sizeNoDestroy (total 8B)
- STORE_STATE: 4B size + 4B sizeLocals (total 10B)
- And others (see documentation)
</td>
</tr>
</table>

  </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  </body>
</html>
      
